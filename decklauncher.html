<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Chiriboga Deck Launcher</title>
		<link href="images/favicon.ico" rel="icon">
		<link rel="stylesheet" href="style.css" />
		<link rel="manifest" href="manifest.json">
		<script src="jquery/jquery-3.2.1.min.js"></script>
		<script src="deck/lz-string.min.js"></script>
		<script src="deck/seedrandom.min.js"></script>
		<script>
			//create some faux variables so we can load the card definitions
			var runner = {};
			var corp = {};
		</script>
		<script src="utility.js"></script>
		<script src="sets/systemgateway.js"></script>
		<script>
			var json = {};
			var cardSet = systemGateway;
			var uid = 0;

			var deckPlayer = corp;
			if (URIParameter("r") !== "") deckPlayer = runner;

			if (deckPlayer == corp) dC = "c";
			//deckchar is c for corp
			else dC = "r"; //deckchar is r for runner

			var playerIdentities = [];
			if (deckPlayer == runner) playerIdentities = [1, 10, 19];
			else playerIdentities = [35, 43, 51, 59];

			function UpdateLaunchStrings() {
			  //console.log(json);
			  var string = JSON.stringify(json);
			  var compressed = LZString.compressToEncodedURIComponent(string);
			  var launchAddress = "engine.php?" + dC + "=" + compressed;
			  $("#launch").prop("href", launchAddress);
			  history.replaceState(
				null,
				"Chiriboga",
				"decklauncher.html?" + dC + "=" + compressed
			  );
			}

			var mouseDownCallback = function (ev) {
			  if (ev.which == 3) {
				//right
				var id = parseInt($(this).attr("data-id"));
				var line = parseInt($(this).attr("data-line"));
				var deckListArray = $("#deck").val().split("\n");
				var thisLineArray = deckListArray[line].split(" ");
				//if (thisLineArray[0] < 3) //limit to 3 of each
				//{
				thisLineArray[0]++;
				deckListArray[line] = thisLineArray.join(" ");
				$("#deck").val(deckListArray.join("\n"));
				$(this).append(
				  '<img src="images/' +
					systemGateway[id].imageFile +
					'" style="margin-left: -120px; transform:rotate(' +
					(Math.random() * 10 - 5) +
					'deg);">'
				);
				json.systemGateway.push(id); //just on the end is fine
				Parse();
				//}
			  }
			  if (ev.which == 1) {
				//left
				var id = parseInt($(this).attr("data-id"));
				var line = parseInt($(this).attr("data-line"));
				$(this).children().last().remove();
				var deckListArray = $("#deck").val().split("\n");
				var thisLineArray = deckListArray[line].split(" ");
				thisLineArray[0]--;
				if (thisLineArray[0] < 1) {
				  //none left, this will invalidate some data-line
				  $(".cardgroup").each(function () {
					var thisLine = parseInt($(this).attr("data-line"));
					if (thisLine > line) $(this).attr("data-line", thisLine - 1);
				  });
				  deckListArray.splice(line, 1);
				} else deckListArray[line] = thisLineArray.join(" ");
				$("#deck").val(deckListArray.join("\n"));
				json.systemGateway.splice(json.systemGateway.indexOf(id), 1); //remove the first-found is fine
				Parse();
			  }
			};

			function GenerateDeck() {
			  var playerCards = [];
			  if (deckPlayer == runner)
				playerCards = [
				  2, 3, 4, 5, 6, 7, 8, 9, 11, 12, 13, 14, 15, 16, 17, 18, 20, 21, 22, 23,
				  24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34,
				];
			  else
				playerCards = [
				  36, 37, 38, 39, 40, 41, 42, 44, 45, 46, 47, 48, 49, 50, 52, 53, 54, 55,
				  56, 57, 58, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74,
				  75,
				];

			  var countSoFar = []; //of each card (by name)
			  for (var i = 0; i < playerCards.length; i++) {
				countSoFar[i] = 0;
			  }

			  //LOAD deck, if specified (as an LZ compressed JSON object containing .identity= and .systemGateway=[], wth cards specified by number in the set)
			  var specifiedPlayerDeck = URIParameter(dC);
			  if (specifiedPlayerDeck != "" && specifiedPlayerDeck != "random") {
				json = JSON.parse(
				  LZString.decompressFromEncodedURIComponent(specifiedPlayerDeck)
				);
				$("#identityselect option[value=" + json.identity + "]").prop(
				  "selected",
				  "selected"
				);
				$("#identity").prop(
				  "src",
				  "images/" + systemGateway[json.identity].imageFile
				);
				for (var i = 0; i < json.systemGateway.length; i++) {
				  countSoFar[playerCards.indexOf(json.systemGateway[i])]++;
				}
			  } //create a random deck for this identity
			  else {
				if (deckPlayer == runner) {
				  var runnerFaction = cardSet[json.identity].faction;
				  var cardsChosen = [];
				  var influenceUsed = 0;
				  //consoles
				  var consoleCards = [3, 23, 14];
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					consoleCards,
					cardsChosen,
					1,
					0
				  );
				  //fracters
				  var fracterCards = [6, 16];
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					fracterCards,
					cardsChosen,
					cardsChosen.length + RandomRange(1, 2),
					3
				  );
				  //decoders
				  var decoderCards = [5, 26];
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					decoderCards,
					cardsChosen,
					cardsChosen.length + RandomRange(1, 2),
					3
				  );
				  //killer
				  var killerCards = [15, 25];
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					killerCards,
					cardsChosen,
					cardsChosen.length + RandomRange(1, 2),
					3
				  );
				  //economy
				  var economyCards = [7, 18, 20, 27, 29, 30, 33]; //only includes cards that would fairly certainly provide credits
				  var influenceUsed = CountInfluence(
					cardSet[json.identity],
					systemGateway,
					cardsChosen
				  );
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					economyCards,
					cardsChosen,
					cardsChosen.length + RandomRange(9, 11),
					9 - influenceUsed
				  );
				  //any other cards
				  influenceUsed = CountInfluence(
					cardSet[json.identity],
					systemGateway,
					cardsChosen
				  );
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					playerCards,
					cardsChosen,
					40,
					15 - influenceUsed
				  );
				} else {
				  var cardsChosen = [];
				  //agendas
				  var agendaCards = [60, 44, 36, 67, 68, 69, 70, 52];
				  DeckBuildRandomAgendas(
					cardSet[json.identity],
					systemGateway,
					agendaCards,
					cardsChosen,
					44
				  );
				  //economy
				  var economyCards = [37, 48, 56, 64, 71, 75]; //(credit economy only)
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					economyCards,
					cardsChosen,
					cardsChosen.length + RandomRange(9, 11),
					3
				  );
				  var influenceUsed = CountInfluence(
					cardSet[json.identity],
					systemGateway,
					cardsChosen
				  );
				  //ice
				  var iceCards = [38, 62, 39, 46, 54, 47, 72, 63, 55, 73, 74];
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					iceCards,
					cardsChosen,
					cardsChosen.length + RandomRange(15, 18),
					9 - influenceUsed
				  );
				  influenceUsed = CountInfluence(
					cardSet[json.identity],
					systemGateway,
					cardsChosen
				  );
				  //other cards
				  var otherCards = [40, 41, 42, 45, 49, 50, 53, 57, 58, 61, 65, 66];
				  DeckBuildRandomly(
					cardSet[json.identity],
					systemGateway,
					otherCards,
					cardsChosen,
					44,
					15 - influenceUsed
				  );
				}

				//convert generated deck into counts
				for (var i = 0; i < cardsChosen.length; i++) {
				  countSoFar[playerCards.indexOf(cardsChosen[i])]++;
				}
			  }

			  //print into textarea
			  var deckText = "";
			  var numRows = 0;
			  for (var i = 0; i < countSoFar.length; i++) {
				if (countSoFar[i] > 0) {
				  if (numRows > 0) deckText += "\n";
				  deckText += countSoFar[i] + " " + cardSet[playerCards[i]].title;
				  numRows++;
				}
			  }
			  $("#deck").val(deckText);
			  $("#deck").prop("rows", numRows); //resize textarea height to fit
			  $("#deck").on("input propertychange paste", Parse);
			  Parse();
			}

			function Init() {
			  //identity select will regenerate a deck if changed
			  $("#identityselect").change(function () {
				json.identity = $("select#identityselect option:checked").val();
				$("#identity").prop(
				  "src",
				  "images/" + systemGateway[json.identity].imageFile
				);
				history.pushState(null, "Chiriboga", "decklauncher.html"); //so a random deck is generated
				GenerateDeck();
			  });

			  //set up identity select
			  for (var i = 0; i < playerIdentities.length; i++) {
				$("#identityselect").append(
				  "<option value=" +
					playerIdentities[i] +
					">" +
					cardSet[playerIdentities[i]].title +
					"</option>\n"
				);
			  }
			  //choose an identity at random, unless a load string was specified
			  var specifiedPlayerDeck = URIParameter(dC);
			  if (specifiedPlayerDeck == "" || specifiedPlayerDeck == "random") {
				var randomIdentity =
				  playerIdentities[RandomRange(0, playerIdentities.length - 1)];
				$("#identityselect option[value=" + randomIdentity + "]")
				  .prop("selected", "selected")
				  .change(); //calling change also means a deck will be generated
			  } else GenerateDeck(); //this will recognise the input string and load it
			}

			function GetCardIdFromTitle(title) {
			  var soughtCardTitle = title
				.normalize("NFD")
				.replace(/[\u0300-\u036f]/g, "")
				.toLowerCase();
			  for (var i = 0; i < systemGateway.length; i++) {
				if (typeof systemGateway[i] !== "undefined") {
				  var setCardTitle = systemGateway[i].title
					.normalize("NFD")
					.replace(/[\u0300-\u036f]/g, "")
					.toLowerCase();
				  if (setCardTitle === soughtCardTitle) return i;
				}
			  }
			  return -1;
			}

			function Parse() {
			  //disable launch while checking
			  $("#launch").prop("disabled", "disabled");
			  $("#launch").html("Checking...");
			  $("#output").html("");
			  $(".cardgroup").remove();

			  //read the textarea and create the deck
			  var validDeck = true;
			  var totalCards = 0;
			  var totalInfluence = 0;
			  var totalAgendaPoints = 0; //only for corp
			  var outputLine = 0;
			  json.systemGateway = [];
			  var splitText = $("#deck").val().split("\n");
			  for (var i = 0; i < splitText.length; i++) {
				var cardCount = 0;
				var cardTitle = "";
				var splitLine = splitText[i].split(" ");
				if (splitLine.length == 1) {
				  cardCount = 1;
				  cardTitle = splitLine[0];
				} else if (splitLine.length > 1) {
				  cardCount = parseInt(splitLine[0]);
				  cardTitle = splitLine.slice(1).join(" ");
				}
				if (cardCount > 0 && cardTitle != "") {
				  var id = GetCardIdFromTitle(cardTitle);
				  if (id > -1) {
					if (cardSet[id].player == deckPlayer) {
					  $("#contentcontainer").append(
						'<div id="cg-' +
						  uid++ +
						  '" class="cardgroup" style="float:left;" data-id="' +
						  id +
						  '" data-line="' +
						  outputLine +
						  '" oncontextmenu="return false"></div>'
					  );
					  Math.seedrandom(id);
					  for (var j = 0; j < cardCount; j++) {
						totalCards++;
						if (cardSet[id].faction !== cardSet[json.identity].faction)
						  totalInfluence += cardSet[id].influence;
						if (
						  deckPlayer == corp &&
						  typeof cardSet[id].agendaPoints !== "undefined"
						)
						  totalAgendaPoints += cardSet[id].agendaPoints;
						json.systemGateway.push(id);
						var stylestr = "";
						if (j > 0)
						  stylestr =
							'" style="margin-left: -120px; transform:rotate(' +
							(Math.random() * 10 - 5) +
							"deg);";
						$("#contentcontainer")
						  .children()
						  .last()
						  .append(
							'<img src="images/' + cardSet[id].imageFile + stylestr + '">'
						  );
					  }
					  $("#contentcontainer").children().last().mousedown(mouseDownCallback);
					  outputLine++;
					} else {
					  if (deckPlayer == runner)
						$("#output").append(cardTitle + " is not a Runner card<br/>");
					  else $("#output").append(cardTitle + " is not a Corp card<br/>");
					  validDeck = false;
					}
				  } else {
					$("#output").append(cardTitle + " not found in System Gateway<br/>");
					validDeck = false;
				  }
				}
			  }
			  //done checking, permit launch if valid
			  if (validDeck) {
				var validityOutput = "";
				numstylestr = "";
				if (totalCards < 40) numstylestr = ' style="color:red;"';
				infstylestr = "";
				if (totalInfluence > 15) infstylestr = ' style="color:red;"';
				if (totalCards !== 1)
				  validityOutput +=
					"<span" +
					numstylestr +
					">" +
					totalCards +
					" cards </span><span" +
					infstylestr +
					">(" +
					totalInfluence +
					" influence)</span>";
				else
				  validityOutput += totalCards + " card (" + totalInfluence + " influence)";
				if (deckPlayer == corp) {
				  var agendaMin = 2 * Math.floor(totalCards / 5) + 2;
				  var agendaMax = agendaMin + 1;
				  agpstylestr = "";
				  if (totalAgendaPoints < agendaMin || totalAgendaPoints > agendaMax)
					agpstylestr = ' style="color:red;"';
				  if (totalAgendaPoints !== 1)
					validityOutput +=
					  "<br><span" +
					  agpstylestr +
					  ">" +
					  totalAgendaPoints +
					  " agenda points (" +
					  agendaMin +
					  "-" +
					  agendaMax +
					  ")</span>";
				  else
					validityOutput +=
					  "<br><span" +
					  agpstylestr +
					  ">1 agenda point (" +
					  agendaMin +
					  "-" +
					  agendaMax +
					  ")</span>";
				}
				$("#output").html(validityOutput);
				$("#launch").prop("disabled", false);
			  }
			  $("#launch").html("Launch");
			  UpdateLaunchStrings();
			}
		</script>
		<style>
			img {
				width: 144px;
				margin: 15px;
			}
			
			body {
			  background-image: url('images/bg.jpg');
			  background-size:cover;
			}
			
			.button {
				margin-bottom: -15px;
			}
			
			.cardgroup {
				cursor:pointer;
			}
		</style>
	</head>


	<body onload="Init();">
		<div id="contentcontainer">
			<div id="dataentry" style="width:440px; float:left; padding:30px;">
				<select id="identityselect"></select>
				<img id="identity" src="images/glow_outline.png">
				<textarea id="deck" spellcheck="false" cols="30"></textarea><br/>
				<div id="output"></div><br/>
				<button id="exittomenu" onclick="window.location.href='index.html';" class="button">Exit to main menu</button>
				<button id="launch" class="button" onclick="window.location.href=$(this).prop('href');">Launch</a>
			</div>
		</div>
	</body>
</html>
